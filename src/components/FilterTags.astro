---
import { PRICE_CATEGORIES, STATUS_CATEGORIES, SUBJECT_CATEGORIES } from '../lib/categories';

const SORT_OPTIONS = [
  { value: 'date', label: 'תאריך (חדש לישן)' },
  { value: 'price-asc', label: 'מחיר (נמוך לגבוה)' },
  { value: 'price-desc', label: 'מחיר (גבוה לנמוך)' },
] as const;

interface Props {
  activePrice?: string;
  activeStatus?: string;
  activeSubject?: string;
  activeSort?: string;
}

const { activePrice = '', activeStatus = '', activeSubject = '', activeSort = 'date' } = Astro.props;
---

<div class="filter-bar" id="filter-bar">
  <div class="filter-row">
    <span class="filter-label">מיון:</span>
    <div class="filter-tags" data-filter-type="sort">
      {SORT_OPTIONS.map((opt) => (
        <button
          type="button"
          class={`filter-tag ${activeSort === opt.value ? 'active' : ''}`}
          data-value={opt.value}
        >
          {opt.label}
        </button>
      ))}
    </div>
  </div>
  <div class="filter-row">
    <span class="filter-label">מחיר:</span>
    <div class="filter-tags-wrap">
      <button type="button" class="filter-scroll-btn filter-scroll-prev" aria-label="גלילה לאחור" data-for="price"></button>
      <div class="filter-tags" data-filter-type="price">
      {PRICE_CATEGORIES.map((cat) => (
        <button
          type="button"
          class={`filter-tag ${activePrice === cat.slug ? 'active' : ''}`}
          data-value={cat.slug}
        >
          {cat.label}
        </button>
      ))}
      </div>
      <button type="button" class="filter-scroll-btn filter-scroll-next" aria-label="גלילה להבא" data-for="price"></button>
    </div>
  </div>
  <div class="donation-explanation" id="donation-explanation" data-visible={activePrice === 'donation'}>
    <p>
      ציורים לתרומה מתקבלים בתשלום דרך תרומה. בוחרים סכום שתרצו לתרום לאחד הגופים שאבחר,
      שולחים צילום מסך — ויכולים לקבל את הציור.
    </p>
  </div>
  <div class="filter-row">
    <span class="filter-label">נושא:</span>
    <div class="filter-tags-wrap">
      <button type="button" class="filter-scroll-btn filter-scroll-prev" aria-label="גלילה לאחור" data-for="subject"></button>
      <div class="filter-tags" data-filter-type="subject">
      {SUBJECT_CATEGORIES.map((cat) => (
        <button
          type="button"
          class={`filter-tag ${activeSubject === cat.slug ? 'active' : ''}`}
          data-value={cat.slug}
        >
          {cat.label}
        </button>
      ))}
      </div>
      <button type="button" class="filter-scroll-btn filter-scroll-next" aria-label="גלילה להבא" data-for="subject"></button>
    </div>
  </div>
  <div class="filter-row">
    <span class="filter-label">סטטוס:</span>
    <div class="filter-tags-wrap">
      <button type="button" class="filter-scroll-btn filter-scroll-prev" aria-label="גלילה לאחור" data-for="status"></button>
      <div class="filter-tags" data-filter-type="status">
      {STATUS_CATEGORIES.map((cat) => (
        <button
          type="button"
          class={`filter-tag ${activeStatus === cat.slug ? 'active' : ''}`}
          data-value={cat.slug}
        >
          {cat.label}
        </button>
      ))}
      </div>
      <button type="button" class="filter-scroll-btn filter-scroll-next" aria-label="גלילה להבא" data-for="status"></button>
    </div>
  </div>
</div>

<style>
  .filter-bar {
    position: sticky;
    top: 60px;
    z-index: 90;
    max-width: 1000px;
    margin: 0 auto;
    padding: 1rem 1.5rem 0.75rem;
    background: #fff;
    border-bottom: 1px solid #eee;
  }

  .filter-row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.5rem;
  }

  .filter-row:last-child {
    margin-bottom: 0;
  }

  .donation-explanation {
    display: none;
    margin-bottom: 1rem;
    padding: 1rem 1.25rem;
    background: #f5f5f5;
    border-right: 3px solid #222;
    border-radius: 4px;
    font-size: 0.9rem;
    line-height: 1.6;
    color: #333;
  }

  .donation-explanation[data-visible="true"] {
    display: block;
  }

  .donation-explanation p {
    margin: 0;
  }

  .filter-label {
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 0.08em;
    color: #666;
    min-width: 3.5rem;
  }

  .filter-tags-wrap {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    min-width: 0;
    flex: 1;
    position: relative;
  }

  .filter-scroll-btn {
    flex-shrink: 0;
    width: 28px;
    height: 28px;
    border: 1px solid #ddd;
    border-radius: 50%;
    background: #fff;
    color: #333;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s, border-color 0.2s;
    font-size: 0.75rem;
    position: relative;
    z-index: 2;
    box-shadow: 0 0 0 2px #fff;
  }

  .filter-scroll-btn:hover {
    background: #f5f5f5;
    border-color: #999;
  }

  .filter-scroll-btn::before {
    content: '';
    width: 6px;
    height: 6px;
    border-inline-start: 2px solid currentColor;
    border-bottom: 2px solid currentColor;
    transform: rotate(-45deg);
    margin-inline-start: 2px;
  }

  .filter-scroll-next::before {
    transform: rotate(135deg);
    margin-inline-start: -2px;
  }

  .filter-tags {
    display: flex;
    flex-wrap: nowrap;
    gap: 0.5rem;
    align-items: center;
    overflow-x: auto;
    overflow-y: hidden;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: thin;
    padding-inline-end: 0.25rem;
    min-width: 0;
    flex: 1;
  }

  .filter-tags::-webkit-scrollbar {
    height: 4px;
  }

  .filter-tags::-webkit-scrollbar-button {
    width: 0;
    height: 0;
    display: none;
  }

  .filter-tags::-webkit-scrollbar-track {
    background: #f0f0f0;
    border-radius: 2px;
  }

  .filter-tags::-webkit-scrollbar-thumb {
    background: #bbb;
    border-radius: 2px;
  }

  .filter-tag {
    display: inline-block;
    flex-shrink: 0;
    padding: 0.4rem 0.9rem;
    font-size: 0.8rem;
    font-weight: 500;
    letter-spacing: 0.05em;
    border: 1px solid #ddd;
    border-radius: 2rem;
    background: #fff;
    color: #333;
    cursor: pointer;
    transition: all 0.2s;
  }

  .filter-tag:hover {
    border-color: #999;
    background: #f8f8f8;
  }

  .filter-tag.active {
    border-color: #111;
    background: #111;
    color: #fff;
  }

  @media (max-width: 768px) {
    .filter-bar {
      padding: 0.75rem 1rem 0.5rem;
    }

    .filter-tag {
      font-size: 0.75rem;
      padding: 0.35rem 0.75rem;
    }
  }
</style>

<script>
  function getParams() {
    const url = new URL(window.location.href);
    return {
      price: url.searchParams.get('price') || '',
      status: url.searchParams.get('status') || '',
      subject: url.searchParams.get('subject') || '',
      sort: url.searchParams.get('sort') || 'date',
    };
  }

  function applyFilters(price: string, status: string, subject: string) {
    const items = document.querySelectorAll('.grid-item');
    items.forEach((el) => {
      const priceCat = (el as HTMLElement).dataset.priceCat || '';
      const priceNum = parseInt((el as HTMLElement).dataset.price || '', 10);
      const isDonation = (el as HTMLElement).dataset.donation === 'true';
      const sold = (el as HTMLElement).dataset.sold === 'true';
      const subjects = ((el as HTMLElement).dataset.subjects || '').split(',').filter(Boolean);

      let matchPrice = true;
      if (price === 'donation') {
        matchPrice = isDonation;
      } else if (price === '250') {
        matchPrice = isDonation ? false : !isNaN(priceNum) && priceNum <= 250;
      } else if (price === '500') {
        matchPrice = isDonation ? false : !isNaN(priceNum) && priceNum > 250 && priceNum <= 500;
      } else if (price === '800') {
        matchPrice = isDonation ? false : !isNaN(priceNum) && priceNum > 500 && priceNum <= 800;
      }

      const matchStatus =
        !status ||
        (status === 'available' && !sold) ||
        (status === 'sold' && sold);

      const matchSubject = !subject || subjects.includes(subject);

      (el as HTMLElement).style.display = matchPrice && matchStatus && matchSubject ? '' : 'none';
    });
  }

  function updateUrl(price: string, status: string, subject: string, sort: string) {
    const url = new URL(window.location.href);
    if (price) url.searchParams.set('price', price);
    else url.searchParams.delete('price');
    if (status) url.searchParams.set('status', status);
    else url.searchParams.delete('status');
    if (subject) url.searchParams.set('subject', subject);
    else url.searchParams.delete('subject');
    if (sort && sort !== 'date') url.searchParams.set('sort', sort);
    else url.searchParams.delete('sort');
    window.history.replaceState({}, '', url.toString());
  }

  function normDateKey(d: string): string {
    if (!d) return '';
    if (/^\d{4}$/.test(d)) return d + '-01-01';
    return d;
  }

  function reorderGrid(sort: string) {
    const grid = document.querySelector('#artwork-grid .grid');
    if (!grid) return;
    const items = Array.from(grid.querySelectorAll('.grid-item'));
    const sorted = items.slice().sort((a, b) => {
      const elA = a as HTMLElement;
      const elB = b as HTMLElement;
      if (sort === 'price-asc' || sort === 'price-desc') {
        const na = parseInt(elA.dataset.price || '', 10) || 1e9;
        const nb = parseInt(elB.dataset.price || '', 10) || 1e9;
        return sort === 'price-asc' ? na - nb : nb - na;
      }
      const dateA = normDateKey(elA.dataset.date || '');
      const dateB = normDateKey(elB.dataset.date || '');
      return dateB.localeCompare(dateA);
    });
    sorted.forEach((node) => grid.appendChild(node));
  }

  function setActiveButton(type: 'price' | 'status' | 'subject' | 'sort', value: string) {
    const container = document.querySelector(`[data-filter-type="${type}"]`);
    container?.querySelectorAll('.filter-tag').forEach((btn) => {
      btn.classList.toggle('active', (btn as HTMLElement).dataset.value === value);
    });
  }

  function setDonationExplanationVisible(visible: boolean) {
    const el = document.getElementById('donation-explanation');
    if (el) el.dataset.visible = visible ? 'true' : 'false';
  }

  document.addEventListener('DOMContentLoaded', () => {
    const bar = document.getElementById('filter-bar');
    const { price, status, subject, sort } = getParams();

    applyFilters(price, status, subject);
    setActiveButton('price', price);
    setActiveButton('status', status);
    setActiveButton('subject', subject);
    setActiveButton('sort', sort);
    setDonationExplanationVisible(price === 'donation');

    bar?.querySelectorAll('.filter-scroll-btn').forEach((scrollBtn) => {
      scrollBtn.addEventListener('click', () => {
        const wrap = (scrollBtn as HTMLElement).closest('.filter-tags-wrap');
        const tagsEl = wrap?.querySelector('.filter-tags') as HTMLElement | null;
        if (!tagsEl) return;
        const isNext = (scrollBtn as HTMLElement).classList.contains('filter-scroll-next');
        const delta = 180;
        const rtl = document.documentElement.dir === 'rtl';
        const scrollAmount = isNext ? (rtl ? -delta : delta) : (rtl ? delta : -delta);
        tagsEl.scrollBy({ left: scrollAmount, behavior: 'smooth' });
      });
    });

    bar?.addEventListener('click', (e) => {
      const btn = (e.target as HTMLElement).closest('.filter-tag');
      if (!btn) return;

      const type = (btn.closest('[data-filter-type]') as HTMLElement)?.dataset.filterType;
      const value = (btn as HTMLElement).dataset.value || '';

      if (type === 'price') {
        const newPrice = value;
        const { status: s, subject: sub, sort: sortVal } = getParams();
        updateUrl(newPrice, s, sub, sortVal);
        setActiveButton('price', newPrice);
        applyFilters(newPrice, s, sub);
        setDonationExplanationVisible(newPrice === 'donation');
      } else if (type === 'status') {
        const newStatus = value;
        const { price: p, subject: sub, sort: sortVal } = getParams();
        updateUrl(p, newStatus, sub, sortVal);
        setActiveButton('status', newStatus);
        applyFilters(p, newStatus, sub);
      } else if (type === 'subject') {
        const newSubject = value;
        const { price: p, status: s, sort: sortVal } = getParams();
        updateUrl(p, s, newSubject, sortVal);
        setActiveButton('subject', newSubject);
        applyFilters(p, s, newSubject);
      } else if (type === 'sort') {
        const newSort = value;
        const { price: p, status: s, subject: sub } = getParams();
        updateUrl(p, s, sub, newSort);
        setActiveButton('sort', newSort);
        reorderGrid(newSort);
      }
    });
  });
</script>
